name: Minecraft with Playit + Filebase

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  minecraft:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y unzip wget default-jdk zip screen

    - name: Setup Directories
      run: mkdir -p server backups links

    - name: Download Minecraft Server
      run: |
        wget -O server/paper.jar https://api.papermc.io/v2/projects/paper/versions/1.20.1/builds/103/downloads/paper-1.20.1-103.jar
        echo "eula=true" > server/eula.txt

    - name: Restore Backup from Filebase
      run: |
        mkdir -p ~/.aws
        echo "[default]" > ~/.aws/credentials
        echo "aws_access_key_id = ${{ secrets.FILEBASE_ACCESS_KEY }}" >> ~/.aws/credentials
        echo "aws_secret_access_key = ${{ secrets.FILEBASE_SECRET_KEY }}" >> ~/.aws/credentials
        echo "[default]" > ~/.aws/config
        echo "region = auto" >> ~/.aws/config
        echo "output = json" >> ~/.aws/config
        aws s3 cp s3://${{ secrets.FILEBASE_BUCKET }}/mcbackup.zip mcbackup.zip --endpoint-url=https://s3.filebase.com || true
        unzip -o mcbackup.zip -d server || true

    - name: Start Minecraft Server
      run: |
        cd server
        screen -dmS mc java -Xmx2G -jar paper.jar nogui

    - name: Restore Playit Config
      run: |
        mkdir -p ~/.playit
        echo "${{ secrets.PLAYIT_TOML }}" > ~/.playit/.playit.toml

    - name: Start Playit and Save SSH Link
      run: |
        wget https://playit.gg/downloads/playit-linux-amd64 -O playit
        chmod +x playit
        ./playit &

        sleep 20

        SSH_LINK=$(curl -s http://127.0.0.1:8080/ssh)
        echo "$SSH_LINK" > links/ssh.txt

        git config --global user.name "autobot"
        git config --global user.email "bot@example.com"
        git pull origin main
        git add links/ssh.txt
        git commit -m "Update SSH link" || true
        git push origin main

    - name: Backup to Filebase Every 30 Minutes
      run: |
        while true; do
          zip -r mcbackup.zip server
          aws s3 cp mcbackup.zip s3://${{ secrets.FILEBASE_BUCKET }}/mcbackup.zip --endpoint-url=https://s3.filebase.com
          sleep 1800
        done
