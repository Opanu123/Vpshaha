name: Auto VPS Backup to pCloud

on: schedule: - cron: "0 */6 * * *"  # Every 6 hours workflow_dispatch:

jobs: start-vps: runs-on: ubuntu-latest timeout-minutes: 370

steps:
  - name: â¬‡ï¸ Checkout Repo
    uses: actions/checkout@v3

  - name: ğŸ› ï¸ Install zip and curl
    run: |
      sudo apt update && sudo apt install -y zip curl

  - name: ğŸ“ Create directories
    run: mkdir -p links .backup

  - name: ğŸ” Restore from pCloud (Optional)
    env:
      PCLOUD_USER: ${{ secrets.PCLOUD_USER }}
      PCLOUD_PASS: ${{ secrets.PCLOUD_PASS }}
    run: |
      if curl -u "$PCLOUD_USER:$PCLOUD_PASS" -s -f -O https://webdav.pcloud.com/autovps.zip; then
        echo "ğŸ“¦ Restoring backup from pCloud..."
        unzip -o autovps.zip || echo "âŒ Failed to unzip"
      else
        echo "âš ï¸ No backup found on pCloud. Starting fresh."
      fi

  - name: ğŸ” Start tmate (SSH Access)
    run: |
      sudo apt install -y tmate
      tmate -S /tmp/tmate.sock new-session -d
      tmate -S /tmp/tmate.sock wait tmate-ready
      SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
      echo "$SSH" > links/autovps.txt
      echo "âœ… SSH Ready: $SSH"

  - name: ğŸ“„ Commit SSH info to repo
    uses: stefanzweifel/git-auto-commit-action@v5
    with:
      commit_message: "ğŸ” Updated SSH link"
      file_pattern: 'links/*.txt'

  - name: ğŸ’¾ Backup & Upload to pCloud
    if: always()
    env:
      PCLOUD_USER: ${{ secrets.PCLOUD_USER }}
      PCLOUD_PASS: ${{ secrets.PCLOUD_PASS }}
    run: |
      zip -r autovps.zip . -x ".git/*" ".github/*" "links/*" || echo "âŒ Nothing to zip"
      curl -u "$PCLOUD_USER:$PCLOUD_PASS" -T autovps.zip https://webdav.pcloud.com/autovps.zip || echo "âŒ Failed to upload"

  - name: ğŸ’¤ Keep VPS Alive
    run: |
      echo "â³ Sleeping for 6 hours..."
      sleep 21600

